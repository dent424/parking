<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/> 
    <title>Hotel Selection Experiment</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; }
        #hotel-list { list-style-type: none; padding: 0; }
        #hotel-list li { margin-bottom: 10px; }
        #hotel-details { display: none; }
        button { margin-top: 20px; }
        .more-details { margin-left: 10px; color: blue; text-decoration: underline; cursor: pointer; }
        .hotel-radio { margin-right: 10px; }
        .hotel-image { max-width: 100%; height: auto; margin-bottom: 20px; }
        .back-link { display: inline-block; margin-bottom: 20px; color: blue; text-decoration: underline; cursor: pointer; }
        #timer { font-weight: bold; margin-bottom: 20px; font-size: 1.5em; }
        #choose-button { display: none; }
        #confirm-selection { display: none; }
    </style>
</head>
<body>
    <div id="timer">Time remaining: N minutes</div>
    <div id="main-page">
        <h1>Select a Hotel</h1>
        <ul id="hotel-list"></ul>
        <!-- Initially, no choose or confirm buttons are visible. They will be shown dynamically. -->
        <button id="choose-button">Choose Now</button>
        <button id="confirm-selection">Confirm Selection</button>
    </div>
    
    <div id="hotel-details">
        <a id="back-to-main" class="back-link">Back to Main Page</a>
        <h2 id="hotel-name"></h2>
        
        <p><b>Room Quality:</b> <span id="hotel-room"></span></p>
        <p><b>Amenities:</b> <span id="hotel-amenities"></span></p>
        <p><b>Location:</b> <span id="hotel-location"></span></p>
        <p><b>View:</b> <span id="hotel-view"></span></p>
        <p><b>Price:</b> <span id="hotel-price"></span></p>
    </div>

    <script>
    const hotels = [
        { name: "Hotel Sapphire", room: 2, amenities: 1, location: 5, view: 4, price: 4 },
        { name: "Hotel Emerald", room: 3, amenities: 2, location: 9, view: 2, price: 10 },
        { name: "Hotel Opal", room: 7, amenities: 1, location: 1, view: 2, price: 4 },
        { name: "Hotel Quartz", room: 4, amenities: 9, location: 10, view: 1, price: 9 },
        { name: "Hotel Onyx", room: 4, amenities: 9, location: 7, view: 4, price: 8 },
        { name: "Hotel Jasper", room: 10, amenities: 5, location: 1, view: 3, price: 7 },
        { name: "Hotel Amber", room: 6, amenities: 5, location: 3, view: 4, price: 6 },
        { name: "Hotel Topaz", room: 2, amenities: 2, location: 7, view: 2, price: 6 },
        { name: "Hotel Pearl", room: 6, amenities: 10, location: 5, view: 1, price: 8 },
        { name: "Hotel Garnet", room: 9, amenities: 2, location: 7, view: 2, price: 9 },
        { name: "Hotel Amethyst", room: 5, amenities: 6, location: 6, view: 7, price: 4 },
        { name: "Hotel Topiary", room: 2, amenities: 1, location: 4, view: 5, price: 2 },
        { name: "Hotel Birch", room: 4, amenities: 2, location: 7, view: 5, price: 8 },
        { name: "Hotel Maple", room: 6, amenities: 3, location: 6, view: 6, price: 4 },
        { name: "Hotel Pine", room: 5, amenities: 2, location: 10, view: 3, price: 9 }
    ];

    let selectedHotel = null;
    let shuffledHotels = [];

    // Data tracking variables
    let totalClicks = 0;
    const uniqueClicks = new Set();
    const clickedHotelsOrder = [];
    let timeSpentOnTabs = "";
    let currentPageStartTime = Date.now();
    let currentPageName = "Main Page";
    const hotelVerticalPositions = {};

    // Capture the returnUrl from the URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const returnUrl = urlParams.get('returnUrl');

    // Record the start time when the page loads
    const startTime = Date.now();

    // Timer behavior variables
    let browsingEnded = false; // After N minutes, we set this to true and show "Choose" button
    let choosingPhase = false; // After "Choose Now" is clicked, details are disabled and "Confirm Selection" is shown

    function shuffleHotels(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function displayHotels() {
        const hotelList = document.getElementById('hotel-list');
        shuffledHotels = shuffleHotels([...hotels]);
        
        shuffledHotels.forEach((hotel, index) => {
            hotelVerticalPositions[hotel.name] = index;
            const li = document.createElement('li');

            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'hotel';
            radio.value = index;
            radio.id = `hotel-${index}`;
            radio.className = 'hotel-radio';
            radio.onchange = () => selectHotel(index);

            const label = document.createElement('label');
            label.htmlFor = `hotel-${index}`;
            label.textContent = hotel.name;

            const moreDetailsLink = document.createElement('a');
            moreDetailsLink.textContent = "More Details";
            moreDetailsLink.className = "more-details";
            moreDetailsLink.href = "#";
            moreDetailsLink.onclick = (e) => {
                e.preventDefault();
                if (!choosingPhase) {
                    // Still allowed to view details
                    totalClicks++;
                    uniqueClicks.add(index);
                    trackTimeSpent(currentPageName);
                    clickedHotelsOrder.push(hotel.name);
                    showHotelDetails(index);
                } else {
                    // Once in choosing phase, no details allowed
                    alert('You can no longer view hotel details. Please pick a hotel and confirm.');
                }
            };

            li.appendChild(radio);
            li.appendChild(label);
            li.appendChild(moreDetailsLink);
            hotelList.appendChild(li);
        });
    }

    function selectHotel(index) {
        selectedHotel = shuffledHotels[index];
    }

    function showHotelDetails(index) {
        const hotel = shuffledHotels[index];
        document.getElementById('hotel-name').textContent = hotel.name;
        document.getElementById('hotel-room').textContent = hotel.room;
        document.getElementById('hotel-amenities').textContent = hotel.amenities;
        document.getElementById('hotel-location').textContent = hotel.location;
        document.getElementById('hotel-view').textContent = hotel.view;
        document.getElementById('hotel-price').textContent = hotel.price;
        
        document.getElementById('main-page').style.display = 'none';
        document.getElementById('hotel-details').style.display = 'block';
        trackTimeSpent(currentPageName);
        currentPageName = hotel.name;
    }

    document.getElementById('back-to-main').onclick = () => {
        document.getElementById('main-page').style.display = 'block';
        document.getElementById('hotel-details').style.display = 'none';
        trackTimeSpent(currentPageName);
        currentPageName = "Main Page";
    };

    // When "Choose Now" is clicked, we enter choosing phase
    document.getElementById('choose-button').onclick = () => {
        choosingPhase = true;
        // Hide "Choose Now" button and show "Confirm Selection"
        document.getElementById('choose-button').style.display = 'none';
        document.getElementById('confirm-selection').style.display = 'inline-block';

        // Once choosing phase starts, no more details can be opened
        // This is enforced in the moreDetailsLink.onclick handler
    };

    // Confirm selection sends data back to Qualtrics
    document.getElementById('confirm-selection').onclick = () => {
        trackTimeSpent(currentPageName);
        if (selectedHotel) {
            const endTime = Date.now();
            const durationMs = endTime - startTime;
            const durationSeconds = Math.round(durationMs / 1000);

            if (returnUrl) {
                const taskCondition = 'NoTabs';
                const separator = returnUrl.includes('?') ? '&' : '?';
                let redirectTo = `${returnUrl}${separator}selectedHotel=${encodeURIComponent(selectedHotel.name)}`;
                redirectTo += `&TaskCondition=${encodeURIComponent(taskCondition)}`;
                redirectTo += `&TotalClicks=${encodeURIComponent(totalClicks)}`;
                redirectTo += `&UniqueClicks=${encodeURIComponent(uniqueClicks.size)}`;
                redirectTo += `&clickedHotelsOrder=${encodeURIComponent(clickedHotelsOrder.join(' > '))}`;
                redirectTo += `&TaskDuration=${encodeURIComponent(durationSeconds)}`;
                redirectTo += `&timeSpentOnTabs=${encodeURIComponent(timeSpentOnTabs)}`;
                redirectTo += `&hotelVerticalPositions=${encodeURIComponent(JSON.stringify(hotelVerticalPositions))}`;
                
                window.location.href = redirectTo;
            } else {
                alert('Return URL not found. Please try again.');
            }
        } else {
            alert('Please select a hotel before confirming.');
        }
    };

    function trackTimeSpent(pageName) {
        const currentTime = Date.now();
        const timeSpent = ((currentTime - currentPageStartTime) / 1000).toFixed(1);
        if (timeSpent > 0.1) {
            if (timeSpentOnTabs) {
                timeSpentOnTabs += ` > ${pageName}:${timeSpent}s`;
            } else {
                timeSpentOnTabs = `${pageName}:${timeSpent}s`;
            }
        }
        currentPageStartTime = currentTime;
    }

    // Start a timer for N minutes (replace N*60 with your desired total seconds)
    function startTimer(seconds) {
        let timer = seconds;
        const timerElement = document.getElementById('timer');
        const timerInterval = setInterval(() => {
            timer--;
            // Update display in mm:ss format
            const minutes = Math.floor(timer / 60);
            const secs = timer % 60;
            timerElement.textContent = `Time remaining: ${minutes}:${secs < 10 ? '0' : ''}${secs}`;

            if (timer <= 0) {
                clearInterval(timerInterval);
                // Browsing period ended
                browsingEnded = true;
                timerElement.textContent = 'Browsing period ended. You can choose now or keep browsing.';
                // Show "Choose Now" button
                document.getElementById('choose-button').style.display = 'inline-block';

                // At this point, the user can still view details until they press "Choose Now"
            }
        }, 1000);
    }

    window.onload = () => {
        // Set your desired browsing duration here, for example 3 minutes = 180 seconds
        const browsingDuration = 180; 
        startTimer(browsingDuration);
        displayHotels();
    };
    </script>
</body>
</html>
